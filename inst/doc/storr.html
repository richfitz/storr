<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8">
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="author" content="Rich FitzJohn" />

<meta name="date" content="2015-11-14" />

<title>storr</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0A%7D%0Apre%20%7B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>



<div id="header">
<h1 class="title">storr</h1>
<h4 class="author"><em>Rich FitzJohn</em></h4>
<h4 class="date"><em>2015-11-14</em></h4>
</div>


<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">library</span>(storr)</code></pre></div>
<p>At the moment, <code>storr</code> requires a driver to be explicitly given; that will change to be a bit more user-friendly shortly.</p>
<p>The idea with different drivers is that different ways of storing data have different trade-offs in terms of speed, size, concurrency, etc; the approach here should allow different backends to be switched in and out while keeping the same user-facing interface.</p>
<p><code>driver_rds</code> stores contents at some path by saving out to rds files. Here I’m using a temporary directory for the path; the driver will create a number of subdirectories here.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">path &lt;-<span class="st"> </span><span class="kw">tempfile</span>(<span class="st">&quot;storr_&quot;</span>)
dr &lt;-<span class="st"> </span>storr::<span class="kw">driver_rds</span>(path)</code></pre></div>
<p>With this driver object we can create the <code>storr</code> object which is what we actually interact with:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st &lt;-<span class="st"> </span>storr::<span class="kw">storr</span>(<span class="dt">driver=</span>dr)</code></pre></div>
<div id="key-value-store" class="section level1">
<h1>Key-value store:</h1>
<p>The most simple way of interacting with a <code>storr</code> object is <code>get</code>/<code>set</code>/<code>del</code> for getting, setting and deleting data stored at some key. To store data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">set</span>(<span class="st">&quot;mykey&quot;</span>, mtcars)</code></pre></div>
<p>To get the data back</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">head</span>(st$<span class="kw">get</span>(<span class="st">&quot;mykey&quot;</span>))</code></pre></div>
<pre><code>##                    mpg cyl disp  hp drat    wt  qsec vs am gear carb
## Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4
## Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4
## Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1
## Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1
## Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2
## Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1</code></pre>
<p>What is in the <code>storr</code>?</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">list</span>()</code></pre></div>
<pre><code>## [1] &quot;mykey&quot;</code></pre>
<p>Or, much faster, test for existance of a particular key:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">exists</span>(<span class="st">&quot;mykey&quot;</span>)</code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">exists</span>(<span class="st">&quot;another_key&quot;</span>)</code></pre></div>
<pre><code>## [1] FALSE</code></pre>
<p>To delete it:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">del</span>(<span class="st">&quot;mykey&quot;</span>)</code></pre></div>
<p>It’s gone!</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">list</span>()</code></pre></div>
<pre><code>## character(0)</code></pre>
</div>
<div id="lists-and-indexable-serialisation" class="section level1">
<h1>Lists and indexable serialisation</h1>
<p>A disadvantage of saving R objects to disk is you have to read the entire thing in at once. <code>storr</code> addresses one specific solution to this problem; allowing simple indexing of objects that are list-like (i.e., things you could throw at <code>lapply</code> productively).</p>
<p>Here’s a daft object that we want to serialise but address by index later.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">1</span>)
obj &lt;-<span class="st"> </span><span class="kw">setNames</span>(<span class="kw">lapply</span>(<span class="dv">1</span>:<span class="dv">5</span>, runif), letters[<span class="dv">1</span>:<span class="dv">5</span>])
obj</code></pre></div>
<pre><code>## $a
## [1] 0.2655087
## 
## $b
## [1] 0.3721239 0.5728534
## 
## $c
## [1] 0.9082078 0.2016819 0.8983897
## 
## $d
## [1] 0.94467527 0.66079779 0.62911404 0.06178627
## 
## $e
## [1] 0.2059746 0.1765568 0.6870228 0.3841037 0.7698414</code></pre>
<p>Rather than use <code>set</code>, use <code>set_list</code> to assign the object against a key.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">set_list</span>(<span class="st">&quot;mylist&quot;</span>, obj)</code></pre></div>
<p>The object appears in the <code>storr</code> as before</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">list</span>()</code></pre></div>
<pre><code>## [1] &quot;mylist&quot;</code></pre>
<p>and can be accessed in its entirety:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">get</span>(<span class="st">&quot;mylist&quot;</span>)</code></pre></div>
<pre><code>## $a
## [1] 0.2655087
## 
## $b
## [1] 0.3721239 0.5728534
## 
## $c
## [1] 0.9082078 0.2016819 0.8983897
## 
## $d
## [1] 0.94467527 0.66079779 0.62911404 0.06178627
## 
## $e
## [1] 0.2059746 0.1765568 0.6870228 0.3841037 0.7698414</code></pre>
<p>but it has a different type:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">type</span>(<span class="st">&quot;mylist&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;list&quot;</code></pre>
<p>Can be queried on length:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">length_list</span>(<span class="st">&quot;mylist&quot;</span>)</code></pre></div>
<pre><code>## [1] 5</code></pre>
<p>To access an individual element:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">get_list_element</span>(<span class="st">&quot;mylist&quot;</span>, <span class="dv">2</span>)</code></pre></div>
<pre><code>## [1] 0.3721239 0.5728534</code></pre>
<p>To access multiple elements (names are dropped at present, but might be retrieveable as an option in future)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">get_list_elements</span>(<span class="st">&quot;mylist&quot;</span>, <span class="kw">c</span>(<span class="dv">1</span>, <span class="dv">3</span>, <span class="dv">5</span>))</code></pre></div>
<pre><code>## $a
## [1] 0.2655087
## 
## $c
## [1] 0.9082078 0.2016819 0.8983897
## 
## $e
## [1] 0.2059746 0.1765568 0.6870228 0.3841037 0.7698414</code></pre>
<p>To assign to individual elements:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">set_list_element</span>(<span class="st">&quot;mylist&quot;</span>, <span class="dv">3</span>, <span class="st">&quot;a different value&quot;</span>)
st$<span class="kw">get_list_element</span>(<span class="st">&quot;mylist&quot;</span>, <span class="dv">3</span>)</code></pre></div>
<pre><code>## [1] &quot;a different value&quot;</code></pre>
<p>Retrieve the whole list again; names are still there but the value of the 3rd element has changed.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">get</span>(<span class="st">&quot;mylist&quot;</span>)</code></pre></div>
<pre><code>## $a
## [1] 0.2655087
## 
## $b
## [1] 0.3721239 0.5728534
## 
## $c
## [1] &quot;a different value&quot;
## 
## $d
## [1] 0.94467527 0.66079779 0.62911404 0.06178627
## 
## $e
## [1] 0.2059746 0.1765568 0.6870228 0.3841037 0.7698414</code></pre>
<p>Lists can be deleted as before</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">del</span>(<span class="st">&quot;mylist&quot;</span>)</code></pre></div>
</div>
<div id="import-export" class="section level1">
<h1>Import / export</h1>
<p>Objects can be imported in and exported out of a <code>storr</code>;</p>
<p>Import from a list, environment or another <code>storr</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">import</span>(<span class="kw">list</span>(<span class="dt">a=</span><span class="dv">1</span>, <span class="dt">b=</span><span class="dv">2</span>))
st$<span class="kw">list</span>()</code></pre></div>
<pre><code>## [1] &quot;a&quot; &quot;b&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">get</span>(<span class="st">&quot;a&quot;</span>)</code></pre></div>
<pre><code>## [1] 1</code></pre>
<p>Export to an environment or another <code>storr</code></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">e &lt;-<span class="st"> </span><span class="kw">new.env</span>(<span class="dt">parent=</span><span class="kw">emptyenv</span>())
st$<span class="kw">export</span>(e)
<span class="kw">ls</span>(e)</code></pre></div>
<pre><code>## [1] &quot;a&quot; &quot;b&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">e$a</code></pre></div>
<pre><code>## [1] 1</code></pre>
<p>Convenience function that does the same as the above (exports to a new environment that has <code>.GlobalEnv</code> as its parent)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">e2 &lt;-<span class="st"> </span>st$<span class="kw">to_environment</span>()
<span class="kw">ls</span>(e2)</code></pre></div>
<pre><code>## [1] &quot;a&quot; &quot;b&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">parent.env</span>(e2)</code></pre></div>
<pre><code>## &lt;environment: R_GlobalEnv&gt;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st2 &lt;-<span class="st"> </span>storr::<span class="kw">storr</span>(<span class="dt">driver=</span>storr::<span class="kw">driver_rds</span>(<span class="kw">tempfile</span>(<span class="st">&quot;storr_&quot;</span>)))
st2$<span class="kw">list</span>()</code></pre></div>
<pre><code>## character(0)</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st2$<span class="kw">import</span>(st)
st2$<span class="kw">list</span>()</code></pre></div>
<pre><code>## [1] &quot;a&quot; &quot;b&quot;</code></pre>
</div>
<div id="supported-backends" class="section level1">
<h1>Supported backends</h1>
<ul>
<li>environments (<code>driver_environment</code>) - mostly for debugging and transient storage, but by far the fastest.</li>
<li>on disk with rds (<code>driver_rds</code>) - zero dependencies, quite fast, will suffer under high concurrency because there is no file locking.</li>
<li>Redis (<code>driver_redis</code>) - uses <a href="https://github.com/richfitz/redux"><code>redux</code></a> to store the data in a <a href="http://redis.io">Redis</a> database. Slower than rds, but can allow multiple R processes to share the same set of objects.</li>
<li>rlite (<code>driver_rlite</code>) - stores data in an <a href="https://github.com/seppo0010/rlite">rlite</a> using <a href="https://github.com/ropensci/rrlite"><code>rrlite</code></a>. This is the slowest at present and does not support concurrency at all. But rlite has the potential to be as useful as SQLite is so this will improve.</li>
</ul>
</div>
<div id="implementation-details" class="section level1">
<h1>Implementation details</h1>
<p><code>storr</code> includes a few useful features that are common to all drivers.</p>
<div id="content-addressable-lookup" class="section level2">
<h2>Content addressable lookup</h2>
<p>The only thing that is stored against a key is the hash of some object. Each driver does this a different way, but for the rds driver it stores small text files that list the hash in them. So:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dir</span>(<span class="kw">file.path</span>(st$driver$path_keys, <span class="st">&quot;objects&quot;</span>))</code></pre></div>
<pre><code>## [1] &quot;a&quot; &quot;b&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">readLines</span>(<span class="kw">file.path</span>(st$driver$path_keys, <span class="st">&quot;objects&quot;</span>, <span class="st">&quot;a&quot;</span>))</code></pre></div>
<pre><code>## [1] &quot;6717f2823d3202449301145073ab8719&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">get_hash</span>(<span class="st">&quot;a&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;6717f2823d3202449301145073ab8719&quot;</code></pre>
<p>Then there is one big pool of hash / value pairs:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">list_hashes</span>()</code></pre></div>
<pre><code>##  [1] &quot;067388ede97a84d789029a46474f1a59&quot; &quot;07c144ad9ce6f3cc93753f0d9b263dc2&quot;
##  [3] &quot;0ee41d724a288da677db8c7289b18439&quot; &quot;4697e48a88c354742109da507ab018ca&quot;
##  [5] &quot;5a2cb1e91526ac1708d2ea3a5f1ee3dc&quot; &quot;614b2fe52c705051ff330592533e312b&quot;
##  [7] &quot;6717f2823d3202449301145073ab8719&quot; &quot;8d0112c8aa5eb6db2dfa0fe57214cd09&quot;
##  [9] &quot;a63c70e73b58d0823ab3bcbd3b543d6f&quot; &quot;ace5481926963d58fc8e43b2171415d8&quot;
## [11] &quot;cbb08035fe48046c880906c572bf0be9&quot; &quot;db8e490a925a60e62212cefc7674ca02&quot;
## [13] &quot;e53d6fe61209ea6b8d4336f85ede7bb7&quot;</code></pre>
<p>in the rds driver these are stored like so:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dir</span>(<span class="kw">file.path</span>(st$driver$path_data))</code></pre></div>
<pre><code>##  [1] &quot;067388ede97a84d789029a46474f1a59.rds&quot;
##  [2] &quot;07c144ad9ce6f3cc93753f0d9b263dc2.rds&quot;
##  [3] &quot;0ee41d724a288da677db8c7289b18439.rds&quot;
##  [4] &quot;4697e48a88c354742109da507ab018ca.rds&quot;
##  [5] &quot;5a2cb1e91526ac1708d2ea3a5f1ee3dc.rds&quot;
##  [6] &quot;614b2fe52c705051ff330592533e312b.rds&quot;
##  [7] &quot;6717f2823d3202449301145073ab8719.rds&quot;
##  [8] &quot;8d0112c8aa5eb6db2dfa0fe57214cd09.rds&quot;
##  [9] &quot;a63c70e73b58d0823ab3bcbd3b543d6f.rds&quot;
## [10] &quot;ace5481926963d58fc8e43b2171415d8.rds&quot;
## [11] &quot;cbb08035fe48046c880906c572bf0be9.rds&quot;
## [12] &quot;db8e490a925a60e62212cefc7674ca02.rds&quot;
## [13] &quot;e53d6fe61209ea6b8d4336f85ede7bb7.rds&quot;</code></pre>
<p>This is going to need garbage collecting every so often - no reference counting is done so stale objects can build up.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">gc</span>()
st$<span class="kw">list_hashes</span>()</code></pre></div>
<pre><code>## [1] &quot;6717f2823d3202449301145073ab8719&quot; &quot;db8e490a925a60e62212cefc7674ca02&quot;</code></pre>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">dir</span>(<span class="kw">file.path</span>(st$driver$path_data))</code></pre></div>
<pre><code>## [1] &quot;6717f2823d3202449301145073ab8719.rds&quot;
## [2] &quot;db8e490a925a60e62212cefc7674ca02.rds&quot;</code></pre>
<p>Eventually this might be automated but for now it’s not.</p>
</div>
<div id="environment-based-caching" class="section level2">
<h2>Environment-based caching</h2>
<p>Every time data passes across a <code>get</code> or <code>set</code> method, <code>storr</code> stores the data in an environment within the <code>storr</code> object. Because we store the content against its hash, it’s always in sync with what is saved to disk. That means that the look up process goes like this:</p>
<ol style="list-style-type: decimal">
<li>Ask for a key, get returned the hash of the content</li>
<li>Check in the caching environment for that hash and return that if present</li>
<li>If not present, read content from disk/db/wherever the driver stores it and save it into the caching environment</li>
</ol>
<p>Because looking up data in the environment is likely to be orders of magnitide faster than reading from disks or databases, this means that commonly accessed data will be accessed at a similar speed to native R objects, while still immediately reflecting changes to the content (because that would mean the hash changes)</p>
<p>To demonstrate:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st &lt;-<span class="st"> </span>storr::<span class="kw">storr</span>(<span class="dt">driver=</span>storr::<span class="kw">driver_rds</span>(<span class="kw">tempfile</span>(<span class="st">&quot;storr_&quot;</span>)))</code></pre></div>
<p>This is the caching environent; currently empty</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ls</span>(st$envir)</code></pre></div>
<pre><code>## character(0)</code></pre>
<p>Set some key to some data:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">set.seed</span>(<span class="dv">2</span>)
st$<span class="kw">set</span>(<span class="st">&quot;mykey&quot;</span>, <span class="kw">runif</span>(<span class="dv">100</span>))</code></pre></div>
<p>The environment now includes an object with a <em>name</em> that is the same as the <em>hash</em> of its contents:</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">ls</span>(st$envir)</code></pre></div>
<pre><code>## [1] &quot;3386dd0f1a8a3fe4ed209420ea23c8eb&quot;</code></pre>
<p>Extract the object from the environment and hash it</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">storr:::<span class="kw">hash_object</span>(st$envir[[<span class="kw">ls</span>(st$envir)]])</code></pre></div>
<pre><code>## [1] &quot;3386dd0f1a8a3fe4ed209420ea23c8eb&quot;</code></pre>
<p>When we look up the value stored against key <code>mykey</code>, the first step is to check the key/hash map; this returns the key above (this step <em>does</em> involve reading from disk)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$<span class="kw">get_hash</span>(<span class="st">&quot;mykey&quot;</span>)</code></pre></div>
<pre><code>## [1] &quot;3386dd0f1a8a3fe4ed209420ea23c8eb&quot;</code></pre>
<p>It then calls <code>$get_value</code> to extract the value associated with that hash - the first thing that function does is try to locate the hash in the environment, otherwise it reads the data from wherever the driver stores it.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">st$get_value</code></pre></div>
<pre><code>## function (hash, use_cache = TRUE) 
## {
##     envir &lt;- self$envir
##     if (use_cache &amp;&amp; exists0(hash, envir)) {
##         envir[[hash]]
##     }
##     else {
##         value &lt;- self$driver$get_value(hash)
##         if (use_cache) {
##             envir[[hash]] &lt;- value
##         }
##         value
##     }
## }
## &lt;environment: 0x7fd38e2b30e0&gt;</code></pre>
<p>The speed up is going to be fairly context dependent, but 10x seems pretty good in this case (some of the overhead is simply a longer code path as we call out to the driver).</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">hash &lt;-<span class="st"> </span>st$<span class="kw">get_hash</span>(<span class="st">&quot;mykey&quot;</span>)
microbenchmark::<span class="kw">microbenchmark</span>(st$<span class="kw">get_value</span>(hash, <span class="dt">use_cache=</span><span class="ot">TRUE</span>),
                               st$<span class="kw">get_value</span>(hash, <span class="dt">use_cache=</span><span class="ot">FALSE</span>))</code></pre></div>
<pre><code>## Unit: microseconds
##                                   expr    min     lq     mean median
##   st$get_value(hash, use_cache = TRUE)  4.568  4.997  6.68611  6.583
##  st$get_value(hash, use_cache = FALSE) 47.901 48.698 51.88963 49.132
##       uq     max neval
##   6.7915  36.660   100
##  49.7635 133.118   100</code></pre>
</div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
