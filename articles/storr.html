<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>storr • storr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="storr">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">storr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item"><a class="nav-link" href="../articles/storr.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/external.html">external</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/richfitz/storr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>storr</h1>
                        <h4 data-toc-skip class="author">Rich
FitzJohn</h4>
            
            <h4 data-toc-skip class="date">2025-04-16</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/richfitz/storr/blob/master/vignettes/storr.Rmd" class="external-link"><code>vignettes/storr.Rmd</code></a></small>
      <div class="d-none name"><code>storr.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://richfitz.github.io/storr/">storr</a></span><span class="op">)</span></span></code></pre></div>
<p><code>storr</code> provides very simple key/value stores for R. They
attempt to provide the most basic set of key/value lookup functionality
that is completely consistent across a range of different underlying
storage drivers (in memory storage, filesystem and proper databases).
All the storage is <em>content addressable</em>, so keys map onto hashes
and hashes map onto data.</p>
<p>The <code>rds</code> driver stores contents at some path by saving
out to rds files. Here I’m using a temporary directory for the path; the
driver will create a number of subdirectories here.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="st">"storr_"</span><span class="op">)</span></span>
<span><span class="va">st</span> <span class="op">&lt;-</span> <span class="fu">storr</span><span class="fu">::</span><span class="fu"><a href="../reference/storr_rds.html">storr_rds</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span></span></code></pre></div>
<p>Alternatively you can create the driver explicitly:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">dr</span> <span class="op">&lt;-</span> <span class="fu">storr</span><span class="fu">::</span><span class="fu"><a href="../reference/storr_rds.html">driver_rds</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span></span></code></pre></div>
<p>With this driver object we can create the <code>storr</code> object
which is what we actually interact with:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span> <span class="op">&lt;-</span> <span class="fu">storr</span><span class="fu">::</span><span class="fu"><a href="../reference/storr.html">storr</a></span><span class="op">(</span><span class="va">dr</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="key-value-store">Key-value store<a class="anchor" aria-label="anchor" href="#key-value-store"></a>
</h2>
<p>The main way of interacting with a <code>storr</code> object is
<code>get</code>/<code>set</code>/<code>del</code> for getting, setting
and deleting data stored at some key. To store data:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"mykey"</span>, <span class="va">mtcars</span><span class="op">)</span></span></code></pre></div>
<p>To get the data back</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">st</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"mykey"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                    mpg cyl disp  hp drat    wt  qsec vs am gear carb</span></span>
<span><span class="co">## Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4</span></span>
<span><span class="co">## Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4</span></span>
<span><span class="co">## Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1</span></span>
<span><span class="co">## Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1</span></span>
<span><span class="co">## Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2</span></span>
<span><span class="co">## Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1</span></span></code></pre>
<p>What is in the <code>storr</code>?</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "mykey"</span></span></code></pre>
<p>Or, much faster, test for existence of a particular key:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">exists</span><span class="op">(</span><span class="st">"mykey"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">exists</span><span class="op">(</span><span class="st">"another_key"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] FALSE</span></span></code></pre>
<p>To delete a key:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">del</span><span class="op">(</span><span class="st">"mykey"</span><span class="op">)</span></span></code></pre></div>
<p>It’s gone!</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## character(0)</span></span></code></pre>
<p>though the actual data is still stored in the database:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">h</span> <span class="op">&lt;-</span> <span class="va">st</span><span class="op">$</span><span class="fu">list_hashes</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">h</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "a63c70e73b58d0823ab3bcbd3b543d6f"</span></span></code></pre>
<p>The hash of an object is computed using the <code>digest</code>
package, and can be done using the <code>hash_object</code> method of
the storr.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">hash_object</span><span class="op">(</span><span class="va">mtcars</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "a63c70e73b58d0823ab3bcbd3b543d6f"</span></span></code></pre>
<p>An object can be retrieved directly given its hash:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">st</span><span class="op">$</span><span class="fu">get_value</span><span class="op">(</span><span class="va">h</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##                    mpg cyl disp  hp drat    wt  qsec vs am gear carb</span></span>
<span><span class="co">## Mazda RX4         21.0   6  160 110 3.90 2.620 16.46  0  1    4    4</span></span>
<span><span class="co">## Mazda RX4 Wag     21.0   6  160 110 3.90 2.875 17.02  0  1    4    4</span></span>
<span><span class="co">## Datsun 710        22.8   4  108  93 3.85 2.320 18.61  1  1    4    1</span></span>
<span><span class="co">## Hornet 4 Drive    21.4   6  258 110 3.08 3.215 19.44  1  0    3    1</span></span>
<span><span class="co">## Hornet Sportabout 18.7   8  360 175 3.15 3.440 17.02  0  0    3    2</span></span>
<span><span class="co">## Valiant           18.1   6  225 105 2.76 3.460 20.22  1  0    3    1</span></span></code></pre>
<p>similarly, we can test to see if an object is present in the database
using its hash:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">exists_object</span><span class="op">(</span><span class="va">h</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>though now that there are no keys pointing at the data it is subject
to garbage collection:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">del</span> <span class="op">&lt;-</span> <span class="va">st</span><span class="op">$</span><span class="fu">gc</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">del</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "a63c70e73b58d0823ab3bcbd3b543d6f"</span></span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">list_hashes</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## character(0)</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="namespaces">Namespaces<a class="anchor" aria-label="anchor" href="#namespaces"></a>
</h2>
<p>At some point having everything stored in a great big bucket may
become too unstructured. To help with this storr implements a very
simple “namespace” system that may help provide some structure. It is a
single layer of hierarchy above keys; so every key belongs to a
namespace. The default namespace is “objects” but this can be configured
when the storr is created.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="va">default_namespace</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "objects"</span></span></code></pre>
<p>The <code>list_namespaces()</code> method lists all known
namespaces</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">list_namespaces</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "objects"</span></span></code></pre>
<p>To create a new namespace, simply assign an object into it:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"a"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">5</span><span class="op">)</span>, namespace <span class="op">=</span> <span class="st">"other_things"</span><span class="op">)</span></span>
<span><span class="va">st</span><span class="op">$</span><span class="fu">list_namespaces</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "objects"      "other_things"</span></span></code></pre>
<p>The <code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code> method lists the contents of a single
namespace</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## character(0)</span></span></code></pre>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="st">"other_things"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "a"</span></span></code></pre>
<p>To get an object, you must use the correct namespace:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error: key 'a' ('objects') not found</span></span></code></pre>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"other_things"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.080750138 0.834333037 0.600760886 0.157208442 0.007399441</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="bulk-getset">Bulk get/set<a class="anchor" aria-label="anchor" href="#bulk-getset"></a>
</h2>
<p>If you have many values to get or set, for some databases it will be
much more efficient to get and set them in bulk; this is particularly
the case with high-latency databases (e.g., anything over a network
connection, especially an internet connection). To help with this, storr
implements <code>mget</code> and <code>mset</code> methods that allow
multiple values to retrieved or set.</p>
<p>The <code>mset</code> function allows multiple keys (and/or multiple
namespaces) and multiple data elements. The data must have the same
<code><a href="https://rdrr.io/r/base/length.html" class="external-link">length()</a></code> as the number of keys being set.</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">mset</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">3</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">st</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1</span></span></code></pre>
<p>The <code>mget</code> function fetches zero or more elements.</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">mget</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"c"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">## [1] 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">## [1] 2</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[3]]</span></span>
<span><span class="co">## [1] 3</span></span></code></pre>
<p><code>mget</code> <em>always</em> returns a list with the same number
of elements as the number of keys</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">mget</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">## [1] 1</span></span></code></pre>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">mget</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">character</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## list()</span></span></code></pre>
<p>With both <code>mset</code> and <code>mget</code>, both key and
namespace can be vectors; if either non-scalar, they must have the same
length so the logic is fairly predictable</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">mset</span><span class="op">(</span><span class="st">"x"</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span><span class="op">)</span>, namespace <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ns1"</span>, <span class="st">"ns2"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">st</span><span class="op">$</span><span class="fu">mget</span><span class="op">(</span><span class="st">"x"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ns1"</span>, <span class="st">"ns2"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">## [1] "a"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">## [1] "b"</span></span></code></pre>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">mget</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"a"</span>, <span class="st">"b"</span>, <span class="st">"x"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"objects"</span>, <span class="st">"objects"</span>, <span class="st">"ns1"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [[1]]</span></span>
<span><span class="co">## [1] 1</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[2]]</span></span>
<span><span class="co">## [1] 2</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## [[3]]</span></span>
<span><span class="co">## [1] "a"</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="import-export">Import / export<a class="anchor" aria-label="anchor" href="#import-export"></a>
</h2>
<p>Objects can be imported in and exported out of a
<code>storr</code>:</p>
<p>Import from a list, environment or another <code>storr</code></p>
<div class="sourceCode" id="cb55"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">import</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>a <span class="op">=</span> <span class="fl">1</span>, b <span class="op">=</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">st</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "a" "b" "c"</span></span></code></pre>
<div class="sourceCode" id="cb57"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1</span></span></code></pre>
<p>Export to an environment (or another <code>storr</code>)</p>
<div class="sourceCode" id="cb59"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">e</span> <span class="op">&lt;-</span> <span class="va">st</span><span class="op">$</span><span class="fu">export</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span>parent <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">emptyenv</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="va">e</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "a" "b" "c"</span></span></code></pre>
<div class="sourceCode" id="cb61"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">e</span><span class="op">$</span><span class="va">a</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1</span></span></code></pre>
<div class="sourceCode" id="cb63"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st_copy</span> <span class="op">&lt;-</span> <span class="va">st</span><span class="op">$</span><span class="fu">export</span><span class="op">(</span><span class="fu"><a href="../reference/storr_environment.html">storr_environment</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">st_copy</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "a" "b" "c"</span></span></code></pre>
<div class="sourceCode" id="cb65"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 1</span></span></code></pre>
<div class="sourceCode" id="cb67"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st2</span> <span class="op">&lt;-</span> <span class="fu">storr</span><span class="fu">::</span><span class="fu"><a href="../reference/storr.html">storr</a></span><span class="op">(</span>driver <span class="op">=</span> <span class="fu">storr</span><span class="fu">::</span><span class="fu"><a href="../reference/storr_rds.html">driver_rds</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="st">"storr_"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">st2</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## character(0)</span></span></code></pre>
<div class="sourceCode" id="cb69"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st2</span><span class="op">$</span><span class="fu">import</span><span class="op">(</span><span class="va">st</span><span class="op">)</span></span>
<span><span class="va">st2</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "a" "b" "c"</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="supported-backends">Supported backends<a class="anchor" aria-label="anchor" href="#supported-backends"></a>
</h2>
<ul>
<li>environments (<code>driver_environment</code>) - mostly for
debugging and transient storage, but by far the fastest.</li>
<li>on disk with rds (<code>driver_rds</code>) - zero dependencies,
quite fast, will suffer under high concurrency because there is no file
locking.</li>
<li>DBI (<code>driver_dbi</code>) - uses (abuses?) a relational database
to store the data. This is not the fastest interface but allows for
interprocess key/value stores where a relational database is supported.
All databases supported by DBI are supported (so at least
<code>SQLite</code>, <code>MySQL</code> and <code>Postgres</code>).</li>
<li>Redis (<code>driver_redis</code>) - uses <a href="https://github.com/richfitz/redux" class="external-link"><code>redux</code></a> to store
the data in a Redis (<code>http://redis.io</code>) database. About the
same speed as rds (faster write, slower read at present), but can allow
multiple R processes to share the same set of objects.</li>
<li>
<code>rlite</code> (<code>driver_rlite</code>) - stores data in an
<a href="https://github.com/seppo0010/rlite" class="external-link"><code>rlite</code></a>
database using <a href="https://github.com/ropensci/rrlite" class="external-link"><code>rrlite</code></a>. This
is quite quick, but is stalled for general release because
<code>rrlite</code> does not support windows.</li>
<li>The in-development package <a href="https://github.com/richfitz/thor" class="external-link"><code>thor</code></a> provides
an alternative on-disk storr that can handle multiple processes on a
single machine.</li>
</ul>
</div>
<div class="section level2">
<h2 id="implementation-details">Implementation details<a class="anchor" aria-label="anchor" href="#implementation-details"></a>
</h2>
<p><code>storr</code> includes a few useful features that are common to
all drivers.</p>
<div class="section level3">
<h3 id="content-addressable-lookup">Content addressable lookup<a class="anchor" aria-label="anchor" href="#content-addressable-lookup"></a>
</h3>
<p>The only thing that is stored against a key is the hash of some
object. Each driver does this a different way, but for the rds driver it
stores small text files that list the hash in them. So:</p>
<div class="sourceCode" id="cb71"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"keys"</span>, <span class="st">"objects"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "a" "b" "c"</span></span></code></pre>
<div class="sourceCode" id="cb73"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/readLines.html" class="external-link">readLines</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"keys"</span>, <span class="st">"objects"</span>, <span class="st">"a"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "6717f2823d3202449301145073ab8719"</span></span></code></pre>
<div class="sourceCode" id="cb75"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">get_hash</span><span class="op">(</span><span class="st">"a"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "6717f2823d3202449301145073ab8719"</span></span></code></pre>
<p>Then there is one big pool of hash / value pairs:</p>
<div class="sourceCode" id="cb77"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">list_hashes</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "07791acf30327c525aa5a1525f9a6a27" "127a2ec00989b9f7faf671ed470be7f8"</span></span>
<span><span class="co">## [3] "6717f2823d3202449301145073ab8719" "db8e490a925a60e62212cefc7674ca02"</span></span>
<span><span class="co">## [5] "ddf100612805359cd81fdc5ce3b9fbba" "e5b57f323c7b3719bbaaf9f96b260d39"</span></span></code></pre>
<p>in the rds driver these are stored like so:</p>
<div class="sourceCode" id="cb79"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/list.files.html" class="external-link">dir</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/file.path.html" class="external-link">file.path</a></span><span class="op">(</span><span class="va">path</span>, <span class="st">"data"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "07791acf30327c525aa5a1525f9a6a27.rds"</span></span>
<span><span class="co">## [2] "127a2ec00989b9f7faf671ed470be7f8.rds"</span></span>
<span><span class="co">## [3] "6717f2823d3202449301145073ab8719.rds"</span></span>
<span><span class="co">## [4] "db8e490a925a60e62212cefc7674ca02.rds"</span></span>
<span><span class="co">## [5] "ddf100612805359cd81fdc5ce3b9fbba.rds"</span></span>
<span><span class="co">## [6] "e5b57f323c7b3719bbaaf9f96b260d39.rds"</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="environment-based-caching">Environment-based caching<a class="anchor" aria-label="anchor" href="#environment-based-caching"></a>
</h3>
<p>Every time data passes across a <code>get</code> or <code>set</code>
method, <code>storr</code> stores the data in an environment within the
<code>storr</code> object. Because we store the content against its
hash, it’s always in sync with what is saved to disk. That means that
the look-up process goes like this:</p>
<ol style="list-style-type: decimal">
<li>Ask for a key, get returned the hash of the content</li>
<li>Check in the caching environment for that hash and return that if
present</li>
<li>If not present, read content from disk/db/wherever the driver stores
it and save it into the caching environment</li>
</ol>
<p>Because looking up data in the environment is likely to be orders of
magnitude faster than reading from disks or databases, this means that
commonly accessed data will be accessed at a similar speed to native R
objects, while still immediately reflecting changes to the content
(because that would mean the hash changes)</p>
<p>To demonstrate:</p>
<div class="sourceCode" id="cb81"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span> <span class="op">&lt;-</span> <span class="fu">storr</span><span class="fu">::</span><span class="fu"><a href="../reference/storr.html">storr</a></span><span class="op">(</span>driver <span class="op">=</span> <span class="fu">storr</span><span class="fu">::</span><span class="fu"><a href="../reference/storr_rds.html">driver_rds</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="st">"storr_"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>This is the caching environment; currently empty</p>
<div class="sourceCode" id="cb82"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="va">st</span><span class="op">$</span><span class="va">envir</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## character(0)</span></span></code></pre>
<p>Set some key to some data:</p>
<div class="sourceCode" id="cb84"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">st</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"mykey"</span>, <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">100</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The environment now includes an object with a <em>name</em> that is
the same as the <em>hash</em> of its contents:</p>
<div class="sourceCode" id="cb85"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="va">st</span><span class="op">$</span><span class="va">envir</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "3386dd0f1a8a3fe4ed209420ea23c8eb"</span></span></code></pre>
<p>Extract the object from the environment and hash it</p>
<div class="sourceCode" id="cb87"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">hash_object</span><span class="op">(</span><span class="va">st</span><span class="op">$</span><span class="va">envir</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/ls.html" class="external-link">ls</a></span><span class="op">(</span><span class="va">st</span><span class="op">$</span><span class="va">envir</span><span class="op">)</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "3386dd0f1a8a3fe4ed209420ea23c8eb"</span></span></code></pre>
<p>When we look up the value stored against key <code>mykey</code>, the
first step is to check the key/hash map; this returns the key above
(this step <em>does</em> involve reading from disk)</p>
<div class="sourceCode" id="cb89"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">get_hash</span><span class="op">(</span><span class="st">"mykey"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "3386dd0f1a8a3fe4ed209420ea23c8eb"</span></span></code></pre>
<p>It then calls <code>$get_value</code> to extract the value associated
with that hash - the first thing that function does is try to locate the
hash in the environment, otherwise it reads the data from wherever the
driver stores it.</p>
<div class="sourceCode" id="cb91"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="va">get_value</span></span></code></pre></div>
<pre><code><span><span class="co">## function (hash, use_cache = TRUE) </span></span>
<span><span class="co">## {</span></span>
<span><span class="co">##     envir &lt;- self$envir</span></span>
<span><span class="co">##     if (use_cache &amp;&amp; exists0(hash, envir)) {</span></span>
<span><span class="co">##         value &lt;- envir[[hash]]</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">##     else {</span></span>
<span><span class="co">##         if (self$traits$throw_missing) {</span></span>
<span><span class="co">##             value &lt;- tryCatch(self$driver$get_object(hash), error = function(e) stop(HashError(hash)))</span></span>
<span><span class="co">##         }</span></span>
<span><span class="co">##         else {</span></span>
<span><span class="co">##             if (!self$driver$exists_object(hash)) {</span></span>
<span><span class="co">##                 stop(HashError(hash))</span></span>
<span><span class="co">##             }</span></span>
<span><span class="co">##             value &lt;- self$driver$get_object(hash)</span></span>
<span><span class="co">##         }</span></span>
<span><span class="co">##         if (use_cache) {</span></span>
<span><span class="co">##             envir[[hash]] &lt;- value</span></span>
<span><span class="co">##         }</span></span>
<span><span class="co">##     }</span></span>
<span><span class="co">##     value</span></span>
<span><span class="co">## }</span></span>
<span><span class="co">## &lt;environment: 0x55c4cc0eaa30&gt;</span></span></code></pre>
<p>The speed up is going to be fairly context dependent, but 5-10x seems
pretty good in this case (some of the overhead is simply a longer code
path as we call out to the driver). For big bits of data and slow
network connections the difference will be much more pronounced.</p>
<div class="sourceCode" id="cb93"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hash</span> <span class="op">&lt;-</span> <span class="va">st</span><span class="op">$</span><span class="fu">get_hash</span><span class="op">(</span><span class="st">"mykey"</span><span class="op">)</span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/ns-load.html" class="external-link">requireNamespace</a></span><span class="op">(</span><span class="st">"rbenchmark"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu">rbenchmark</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rbenchmark/man/benchmark.html" class="external-link">benchmark</a></span><span class="op">(</span><span class="va">st</span><span class="op">$</span><span class="fu">get_value</span><span class="op">(</span><span class="va">hash</span>, use_cache <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                        <span class="va">st</span><span class="op">$</span><span class="fu">get_value</span><span class="op">(</span><span class="va">hash</span>, use_cache <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>,</span>
<span>                        replications <span class="op">=</span> <span class="fl">1000</span>, order <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">4</span><span class="op">]</span></span>
<span><span class="op">}</span></span></code></pre></div>
<pre><code><span><span class="co">## Loading required namespace: rbenchmark</span></span></code></pre>
<pre><code><span><span class="co">##                                    test replications elapsed relative</span></span>
<span><span class="co">## 1  st$get_value(hash, use_cache = TRUE)         1000   0.010      1.0</span></span>
<span><span class="co">## 2 st$get_value(hash, use_cache = FALSE)         1000   0.063      6.3</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="classed-exceptions">Classed exceptions<a class="anchor" aria-label="anchor" href="#classed-exceptions"></a>
</h3>
<p>storr uses R’s exception handling system and errors inspired from
Python to make it easy to program with <code>tryCatch</code>.</p>
<p>If a key is not in the database, storr will return a
<code>KeyError</code> (not <code>NULL</code> because storing a
<code>NULL</code> value is a perfectly reasonable thing to do).</p>
<p>If you <em>did</em> want to return <code>NULL</code> when a key is
requested but not present, use <code>tryCatch</code> in this way:</p>
<div class="sourceCode" id="cb96"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="va">st</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"no_such_key"</span><span class="op">)</span>,</span>
<span>         KeyError <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="cn">NULL</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## NULL</span></span></code></pre>
<p>See <code><a href="https://rdrr.io/r/base/conditions.html" class="external-link">?tryCatch</a></code> for details. The idea is that key lookup
errors will have the class <code>KeyError</code> so will be caught here
and run the given function (the argument <code>e</code> is the actual
error object). Other errors will not be caught and will still throw.</p>
<p><code>HashErrors</code> will be rarer, but could happen (they might
occur if your driver supports expiry of objects). We can simulate that
by setting a hash and deleting it:</p>
<div class="sourceCode" id="cb98"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"foo"</span>, <span class="va">letters</span><span class="op">)</span></span>
<span><span class="va">ok</span> <span class="op">&lt;-</span> <span class="va">st</span><span class="op">$</span><span class="va">driver</span><span class="op">$</span><span class="fu">del_object</span><span class="op">(</span><span class="va">st</span><span class="op">$</span><span class="fu">get_hash</span><span class="op">(</span><span class="st">"foo"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">st</span><span class="op">$</span><span class="fu">flush_cache</span><span class="op">(</span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="va">st</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"foo"</span><span class="op">)</span>,</span>
<span>         KeyError <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="cn">NULL</span>,</span>
<span>         HashError <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"Data is deleted"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Data is deleted</span></span></code></pre>
<p>Here the <code>HashError</code> is triggered.</p>
<p><code>KeyError</code> objects include <code>key</code> and
<code>namespace</code> elements, <code>HashError</code> objects include
a <code>hash</code> element. They both inherit from
<code>c("error", "condition")</code>.</p>
<p>Finally, when using an external storr (see ?driver_external) storr
will throw a <code>KeyErrorExternal</code> if the
<code>fetch_hook</code> function errors while trying to retrieve an
external resource.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
