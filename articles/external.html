<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>external • storr</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="external">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">storr</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.2.6</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/storr.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/external.html">external</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/richfitz/storr/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>external</h1>
                        <h4 data-toc-skip class="author">Rich
FitzJohn</h4>
            
            <h4 data-toc-skip class="date">2025-04-16</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/richfitz/storr/blob/master/vignettes/external.Rmd" class="external-link"><code>vignettes/external.Rmd</code></a></small>
      <div class="d-none name"><code>external.Rmd</code></div>
    </div>

    
    
<p>Using external storrs.</p>
<p>Often it is useful to retrieve data from an external resource
(especially websites). The way this works is:</p>
<ol style="list-style-type: decimal">
<li><p>We do a key lookup on the storr; if that succeeds (i.e. it maps
to a hash) continue as normal..</p></li>
<li><p>If the lookup fails, pass the key (and namespace) to a “hook”
function that generates an R object (in any way).</p></li>
</ol>
<p>This is in some ways a variant on the memoisation pattern; if the key
refers to a set of arguments to a long running function we get something
like memoisation (see the bottom of this file).</p>
<p>As an example, this vignette will download some DESCRIPTION files
from GitHub, using the name of the repository as the key.</p>
<p>The first step is writing a hook function; this is a function with
arguments <code>(key, namespace)</code> that returns an R object. For
packages stored in the root directory of a repository we can build URLs
of the form</p>
<pre><code>https://raw.githubusercontent.com/&lt;username&gt;/&lt;repo&gt;/master/DESCRIPTION</code></pre>
<p>So if the key is a username/repo pair and we ignore namespace we can
write a function:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fetch_hook_gh_description</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">key</span>, <span class="va">namespace</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/capabilities.html" class="external-link">capabilities</a></span><span class="op">(</span><span class="st">"libcurl"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"This vignette requires libcurl support in R to run"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">fmt</span> <span class="op">&lt;-</span> <span class="st">"https://raw.githubusercontent.com/%s/master/DESCRIPTION"</span></span>
<span>  <span class="va">path</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="st">"gh_description_"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/on.exit.html" class="external-link">on.exit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/files.html" class="external-link">file.remove</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">code</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/utils/download.file.html" class="external-link">download.file</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="va">fmt</span>, <span class="va">key</span><span class="op">)</span>, <span class="va">path</span>, mode <span class="op">=</span> <span class="st">"wb"</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">code</span> <span class="op">!=</span> <span class="fl">0L</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"Error downloading file"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/dcf.html" class="external-link">read.dcf</a></span><span class="op">(</span><span class="va">path</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This function downloads the requested DESCRIPTION file into a
temporary file (which it promises to delete later using
<code>on.exit</code>), checks that the download was successful, then
reads in the downloaded file and converts it into a list.</p>
<p>The <code>httr</code> and <code>curl</code> packages make this a
little easier to do with authorisation so that this would work for
private repositories by using a token.</p>
<p>With this in place, we can build a storr:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span> <span class="op">&lt;-</span> <span class="fu">storr</span><span class="fu">::</span><span class="fu"><a href="../reference/storr_external.html">storr_external</a></span><span class="op">(</span><span class="fu">storr</span><span class="fu">::</span><span class="fu"><a href="../reference/storr_environment.html">driver_environment</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                            <span class="va">fetch_hook_gh_description</span><span class="op">)</span></span></code></pre></div>
<p>The first argument here is a storr <em>driver</em> (i.e., a
<code>driver_</code> function). If you have a storr that you want to
use, pass it as <code>st$driver</code> to extract the underlying driver
(and share storage with your existing storr).</p>
<p>As with other storr creation functions, you can set the default
namespace using the <code>default_namespace</code> argument.</p>
<p>The returned object is exactly the same as a usual storr except that
the <code>get</code> method has changed (this is done by inheritance).
The <code>get</code> method only behaves differently when the object is
not present in the storr, in which case it will try to fetch the object
and insert it into the storr.</p>
<p>At first there is nothing in here:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## character(0)</span></span></code></pre>
<p>But we can still <code>get</code> things from the storr:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">d</span> <span class="op">&lt;-</span> <span class="va">st</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"richfitz/storr"</span><span class="op">)</span></span></code></pre></div>
<p>Once a key has been fetched, it will be retrieved locally:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">st</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"richfitz/storr"</span><span class="op">)</span>, <span class="va">d</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>And it will be present within the storr, as shown by
<code>list</code>:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "richfitz/storr"</span></span></code></pre>
<p>If an external resource cannot be located, storr will throw an error
of class <code>KeyErrorExternal</code>:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="va">st</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"richfitz/no_such_repo"</span><span class="op">)</span>,</span>
<span>         KeyErrorExternal <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span></span>
<span>           <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"** Repository %s not found"</span>, <span class="va">e</span><span class="op">$</span><span class="va">key</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Warning in download.file(sprintf(fmt, key), path, mode = "wb"): downloaded</span></span>
<span><span class="co">## length 0 != reported length 14</span></span></code></pre>
<pre><code><span><span class="co">## Warning in download.file(sprintf(fmt, key), path, mode = "wb"): cannot open URL</span></span>
<span><span class="co">## 'https://raw.githubusercontent.com/richfitz/no_such_repo/master/DESCRIPTION':</span></span>
<span><span class="co">## HTTP status was '404 Not Found'</span></span></code></pre>
<pre><code><span><span class="co">## Warning in file.remove(path): cannot remove file</span></span>
<span><span class="co">## '/tmp/Rtmp6ok8z5/gh_description_54c7413ac114', reason 'No such file or</span></span>
<span><span class="co">## directory'</span></span></code></pre>
<pre><code><span><span class="co">## ** Repository richfitz/no_such_repo not found</span></span></code></pre>
<p>This would happen for all errors, including lack of internet
connectivity, corrupt file downloads, etc. The original error will be
returned as the <code>$e</code> element of the error if you need to
distinguish between types of failure. The <code>KeyErrorExternal</code>
is also a <code>KeyError</code> class, so code that catches
<code>KeyErrors</code> will still work as expected.</p>
<p>For more details on storr exception handling, see the
<code>storr</code> vignette
(<code><a href="../articles/storr.html">vignette("storr", package = "storr")</a></code>)</p>
<p>Note that if you want to persist the storage of the descriptions you
would need to mangle the key:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st_rds</span> <span class="op">&lt;-</span> <span class="va">st</span><span class="op">$</span><span class="fu">export</span><span class="op">(</span><span class="fu">storr</span><span class="fu">::</span><span class="fu"><a href="../reference/storr_rds.html">storr_rds</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html" class="external-link">tempfile</a></span><span class="op">(</span><span class="op">)</span>, mangle_key <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">st_rds</span><span class="op">$</span><span class="fu">list</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "richfitz/storr"</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st_rds</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"richfitz/storr"</span><span class="op">)</span><span class="op">$</span><span class="va">Version</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] "1.2.6"</span></span></code></pre>
<p>The <code>st_rds</code> storr does not include the fetch hook; it is
a plain storr.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st_rds</span><span class="op">$</span><span class="fu">destroy</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="memoisation">Memoisation<a class="anchor" aria-label="anchor" href="#memoisation"></a>
</h2>
<p>The external storr can support a form of memoisation, though it might
be simpler to implement this directly (see below).</p>
<p>Suppose you have some expensive function <code>f(a, b)</code></p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"Computing f(%.3f, %.3f)"</span>, <span class="va">a</span>, <span class="va">b</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">## ...expensive computation here...</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">a</span>, <span class="va">b</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>and a set of parameters to run the function over, with each parameter
set (row) associated with an id:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">pars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">10</span><span class="op">)</span>, a <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>, b <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/Uniform.html" class="external-link">runif</a></span><span class="op">(</span><span class="fl">10</span><span class="op">)</span>,</span>
<span>                   stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>The <code>hook</code> here simply looks the parameters up and
arranges to run them:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">hook</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">key</span>, <span class="va">namespace</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">pars</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">key</span>, <span class="va">pars</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="fu">f</span><span class="op">(</span><span class="va">p</span><span class="op">$</span><span class="va">a</span>, <span class="va">p</span><span class="op">$</span><span class="va">b</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">st</span> <span class="op">&lt;-</span> <span class="fu">storr</span><span class="fu">::</span><span class="fu"><a href="../reference/storr_external.html">storr_external</a></span><span class="op">(</span><span class="fu">storr</span><span class="fu">::</span><span class="fu"><a href="../reference/storr_environment.html">driver_environment</a></span><span class="op">(</span><span class="op">)</span>, <span class="va">hook</span><span class="op">)</span></span></code></pre></div>
<p>The first time the result is retrieved the message will be printed
(the function is evaluated)</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x</span> <span class="op">&lt;-</span> <span class="va">st</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"1"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Computing f(0.081, 0.875)</span></span></code></pre>
<p>The second time, it will not be as the result is retrieved from the
storr:</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/identical.html" class="external-link">identical</a></span><span class="op">(</span><span class="va">st</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"1"</span><span class="op">)</span>, <span class="va">x</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] TRUE</span></span></code></pre>
<p>This idea can be generalised by storing the <em>parameters</em> and
the <em>functions</em> in the storr so that we lose the dependency on
the global variables:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">st</span> <span class="op">&lt;-</span> <span class="fu">storr</span><span class="fu">::</span><span class="fu"><a href="../reference/storr_environment.html">storr_environment</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">st</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"experiment1"</span>, <span class="va">pars</span>, namespace <span class="op">=</span> <span class="st">"parameters"</span><span class="op">)</span></span>
<span><span class="va">st</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="st">"experiment1"</span>, <span class="va">f</span>, namespace <span class="op">=</span> <span class="st">"functions"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">hook2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">key</span>, <span class="va">namespace</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">f</span> <span class="op">&lt;-</span> <span class="va">st</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="va">namespace</span>, namespace <span class="op">=</span> <span class="st">"functions"</span><span class="op">)</span></span>
<span>  <span class="va">pars</span> <span class="op">&lt;-</span> <span class="va">st</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="va">namespace</span>, namespace <span class="op">=</span> <span class="st">"parameters"</span><span class="op">)</span></span>
<span>  <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">pars</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span><span class="va">key</span>, <span class="va">pars</span><span class="op">$</span><span class="va">id</span><span class="op">)</span>, <span class="op">-</span><span class="fl">1</span><span class="op">]</span></span>
<span>  <span class="fu">f</span><span class="op">(</span><span class="va">p</span><span class="op">$</span><span class="va">a</span>, <span class="va">p</span><span class="op">$</span><span class="va">b</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">st_use</span> <span class="op">&lt;-</span> <span class="fu">storr</span><span class="fu">::</span><span class="fu"><a href="../reference/storr_external.html">storr_external</a></span><span class="op">(</span><span class="va">st</span><span class="op">$</span><span class="va">driver</span>, <span class="va">hook2</span><span class="op">)</span></span>
<span></span>
<span><span class="va">x1</span> <span class="op">&lt;-</span> <span class="va">st_use</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"1"</span>, <span class="st">"experiment1"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Computing f(0.081, 0.875)</span></span></code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">x2</span> <span class="op">&lt;-</span> <span class="va">st_use</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"1"</span>, <span class="st">"experiment1"</span><span class="op">)</span></span></code></pre></div>
<p>Memoisation in the style of the <code>memoise</code> package is
possible to implement, but is not provided in the package.
Implementation is straightforward and will work with any driver:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">memoise</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">f</span>, <span class="va">driver</span> <span class="op">=</span> <span class="fu">storr</span><span class="fu">::</span><span class="fu"><a href="../reference/storr_environment.html">driver_environment</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/force.html" class="external-link">force</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span>
<span>  <span class="va">st</span> <span class="op">&lt;-</span> <span class="fu">storr</span><span class="fu">::</span><span class="fu"><a href="../reference/storr.html">storr</a></span><span class="op">(</span><span class="va">driver</span><span class="op">)</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co">## NOTE: also digesting the inputs as a key here (in addition to</span></span>
<span>    <span class="co">## storr's usual digesting of values)</span></span>
<span>    <span class="va">key</span> <span class="op">&lt;-</span> <span class="fu">digest</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/digest/man/digest.html" class="external-link">digest</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">...</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>      <span class="va">st</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="va">key</span><span class="op">)</span>,</span>
<span>      KeyError <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">ans</span> <span class="op">&lt;-</span> <span class="fu">f</span><span class="op">(</span><span class="va">...</span><span class="op">)</span></span>
<span>        <span class="va">st</span><span class="op">$</span><span class="fu">set</span><span class="op">(</span><span class="va">key</span>, <span class="va">ans</span><span class="op">)</span></span>
<span>        <span class="va">ans</span></span>
<span>      <span class="op">}</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Here’s a function that will print when it is evaluated</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">f</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"computing..."</span><span class="op">)</span></span>
<span>  <span class="va">x</span> <span class="op">*</span> <span class="fl">2</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Create the memoised function</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">g</span> <span class="op">&lt;-</span> <span class="fu">memoise</span><span class="op">(</span><span class="va">f</span><span class="op">)</span></span></code></pre></div>
<p>The first time an argument is seen, <code>f()</code> will be run,
printing a message</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">g</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## computing...</span></span></code></pre>
<pre><code><span><span class="co">## [1] 2</span></span></code></pre>
<p>Subsequent times will be looked up from the storr:</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">g</span><span class="op">(</span><span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2</span></span></code></pre>
<p>Storr takes about twice as long as memoise (memoise does a direct
key-&gt;value mapping rather than going through hashed values because it
is the only thing that ever touches its cache). However, the overhead is
approximately half of one call to <code><a href="https://rdrr.io/r/base/message.html" class="external-link">message()</a></code> so it’s not
that bad.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Rich FitzJohn.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

    </footer>
</div>





  </body>
</html>
